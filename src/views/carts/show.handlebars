<h1>Carrito</h1>
<p class="muted">Productos del carrito</p>
<hr />
<div id="cart"></div>

<div class="row" style="gap:.5rem;margin-top:1rem">
  <button id="empty">Vaciar carrito</button>
</div>

<script>
  const cid = '{{cid}}';
  const cont = document.getElementById('cart');

  async function load() {
    const data = await (await fetch('/api/carts/'+cid)).json();
    cont.innerHTML = '';
    (data.products || []).forEach(i => {
      const p = i.product || {};
      const el = document.createElement('div');
      el.className = 'card';
      el.dataset.pid = p._id;
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <strong>${p.title ?? ''}</strong><span class="muted">${p.code ?? ''}</span>
        </div>
        <div class="muted">${p.category ?? ''}</div>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <span>$ ${p.price ?? ''} Â· Cant: <b class="q">${i.quantity}</b></span>
          <div>
            <button onclick="chg('${p._id}',-1)">-</button>
            <button onclick="chg('${p._id}',+1)">+</button>
            <button onclick="delp('${p._id}')">Quitar</button>
          </div>
        </div>`;
      cont.appendChild(el);
    });
  }

  async function chg(pid, delta) {
    const card = [...cont.children].find(c => c.dataset.pid === pid);
    const q = Math.max(1, (card ? +card.querySelector('.q').textContent : 1) + delta);
    await fetch(`/api/carts/${cid}/products/${pid}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({quantity:q})
    });
    load();
  }
  async function delp(pid) {
    await fetch(`/api/carts/${cid}/product/${pid}`, { method:'DELETE' });
    load();
  }
  document.getElementById('empty').onclick = async () => {
    await fetch(`/api/carts/${cid}`, { method:'DELETE' });
    load();
  }

  load();
</script>
